name: Generate framework release
on: workflow_dispatch
permissions:
  contents: write
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true
jobs:
  build:
    runs-on: macos-latest
    env:
      HOMEBREW_NO_AUTO_UPDATE: 1

    name: Generate Framework
    steps:
      - run: echo "RELEASE_NAME=Released on $(date +%Y%m%d%H%M)" >> $GITHUB_ENV
      - run: echo "TAG_NAME=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
      # shell: bash

      - name: Check out repository code
      - uses: actions/checkout@v3

      - name: Build device release archive
        run: xcodebuild archive -scheme MyLibrary -destination "generic/platform=iOS" -configuration Release -archivePath "Archives/MyLibrary.framework-iphoneos.xcarchive" SKIP_INSTALL=NO BUILD_LIBRARY_FOR_DISTRIBUTION=YES

      - name: Build device release xcframework
        run: xcodebuild -create-xcframework -framework "Archives/MyLibrary.framework-iphoneos.xcarchive/Products/Library/Frameworks/MyLibrary.framework" -output Archives/xcframeworks/MyLibrary.xcframework

      - name: Create MyLibrary.xcframework.zip
        run: ditto -c -k --sequesterRsrc --keepParent Archives/xcframeworks/MyLibrary.xcframework Archives/MyLibrary.xcframework.zip

      - name: Get Previous tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1
        with:
          fallback: v0.0.2
      - name: Attach ZIP to latest release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: ${{ env.RELEASE_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          draft: false
          prerelease: false
          files: ./Archives/*